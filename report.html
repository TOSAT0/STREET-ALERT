<!DOCTYPE html>
<html>
  <body>
    <h1>HTML Geolocation</h1>
    <p>Click the button to get your coordinates.</p>

    <button onclick="getLocation()">QUESTA E' UNA MAPPA</button>

    <p id="demo"></p>
    <div id="ask"></div>

    <script>
      const x = document.getElementById("demo");
      let xhttp = new XMLHttpRequest()

      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(showPosition);
        } else {
          x.innerHTML = "Geolocation is not supported by this browser.";
        }
      }

      function showPosition(position) {
        let lat = position.coords.latitude
        let lon = position.coords.longitude
        let res

        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            console.log(this.response);

            res = JSON.parse(this.response)
            n = document.getElementById("ask")

            if(res.status == "ok"){
              n.innerHTML = "<h>L'elemento è stato aggiunto al database</h1>"
            }if(res.status == "not_ok"){
              n.innerHTML = "<h1>L'elemento potrebbe già esistere</h1><button onclick='alert("+lat+","+lon+",\"not_exist\")'>NUOVO</button><button onclick='alert("+lat+","+lon+",\"exist\")'>NON NUOVO</button>";
            }
          }
        }

        xhttp.open("GET", "server.php?lat=" + lat + "&lon=" + lon + "&status=report", true)
        xhttp.setRequestHeader("Cache-Control", "no-cache")
        xhttp.send()
      }

      function alert(lat, lon, status){
        xhttp.open("GET", "server.php?lat=" + lat + "&lon=" + lon + "&status="+status, true)
        xhttp.setRequestHeader("Cache-Control", "no-cache")
        xhttp.send()
      }

    </script>

  </body>
</html>
